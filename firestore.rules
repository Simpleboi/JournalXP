rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Public collections -- keep existing defaults

    // Users collection: clients may read user profiles but should NOT be able to modify
    // server-controlled fields such as level, xp, totalXP, achievements, pointsHistory, etc.
    match /users/{userId} {
      allow read: if request.auth != null;

      // Deny client-side creation and full updates. Allow limited updates to safe fields
      // (profilePicture, displayName, username) only by the authenticated user.
      allow create: if false; // server creates user documents via Admin SDK

      allow update: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasOnly(['profilePicture','displayName','username'])
                    && request.resource.data.profilePicture is string || request.resource.data.profilePicture == null;

      allow delete: if false; // prevent client from deleting user documents
    }

    // Fallback: other documents require authentication to read; writes are denied by default
    match /{document=**} {
      allow read: if request.auth != null;
      allow write: if false;
    }
  }
}